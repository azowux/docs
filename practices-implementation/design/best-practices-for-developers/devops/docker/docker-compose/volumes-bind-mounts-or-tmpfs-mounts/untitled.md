# Volumes, bind mounts или tmpfs mounts

### Проблемы с управлением данными в Docker 

По умолчанию, все файлы сохраняются внутри контейнера, что подразумевает:

* Данные не сохраняются, если контейнер удален.
* Память контейнера сильно привязана к серверу, на котором работает контейнер. Не получится легко переместить данные в другое место.
* Запись данных в память контейнера требует наличие [storage driver](https://docs.docker.com/storage/storagedriver/)'а. Storage driver формирует отдельную файловую систему используя Linux kernel. Эта дополнительная абстракция ухудшает производительность в сравнении с _volumes_, которые пишут данные напрямую в файловую систему.

У докера есть две опции для хранения файлов на сервере, чтобы файлы сохранялись даже после остановки контейнера: _volumes_ и _bind mounts_. Если Docker запущен на Linux, можно также использовать _tmpfs mount_.

### Выберите способ хранения данных

В зависимости от того, что вам нужно, можно выбрать между тремя способами хранения данных:

![](../../../../../../../.gitbook/assets/image%20%284%29.png)

* **Volumes** хранятся в той части файловой системы, которая управляется _Docker'ом_ \(`/var/lib/docker/volumes/` в Linux\). Никакие, кроме Docker, процессы не должны модифицировать эту директорию. Volume'ы являются лучшим способом хранить данные из Docker.
* **Bind mounts** могут располагаться в любой директории хоста. Любой процесс может их модифицировать.
* **`tmpfs` mounts** хранятся в оперативной памяти системы.

{% hint style="info" %}
Детальная информация о способах хранения данных доступна на странице документации [docker](https://docs.docker.com/storage/#more-details-about-mount-types).
{% endhint %}

### Сценарии применения:

#### Volumes

Volume'ы являются предпочтительным способом сохранить данные Docker контейнеров и сервисов. 

* Обмениваться данными между множеством запущенных контейнеров. Volume создастся автоматически при первом запуске контейнера. При запуске достаточно просто указать имя для volume. Если контейнер остановлен или удален, volume остается. Множество контейнеров могут монтировать volume одновременно в режимах чтение-запись или только чтение. Volume удаляется только тогда, когда явно указано его удаление.
* Когда не гарантирован доступ к определенной директории или файловой структуре. Volume'ы помогают отделить конфигурацию Docker host'a от работающего контейнера.
* Когда необходимо хранить данные контейнера на удаленной машине или в облаке.
* Когда необходимо сделать бекап, восстановить или мигрировать данные с  Docker host'a в другое место. Можно остановить контейнер, использующий volume и сделать резервную копию директории volume'a \(например, `/var/lib/docker/volumes/<volume-name>`\).
* Когда приложение требует высокой I/O производительности на  Docker Desktop. Volume'ы хранятся в Linux VM, а не на хосте, что означает,  что запись и чтение имеют меньшую задержку и высокую пропускную способность.

#### Bind mounts

В основном, следует использовать volumes'ы везде, где возможно.

* Общий доступ к файлам конфигурации с host-машины к контейнерам. Таким образом, например, Docker редирект DNS для контейнеров внедряя `/etc/resolv.conf` host-машины в каждый контейнер.
* Общий доступ к исходному коду или формирование артефактов между средой разработки на Docker host и контейнером. Например, вы монтируете Maven директорию `target/` в контейнер и каждый раз, когда вы собираете проект Maven на Docker host, контейнер получает доступ к артефактам. Если таким образом вы используете Docker для разработки, ваш production Dockerfile копирует артефакты напрямую в контейнер, а не полагается на bind mount.
* Когда гарантировано, что никакой другой процесс на Docker host не будет модифицировать bind mounts, используемые в контейнерах.

#### Tmpfs mounts

`tmpfs` mounts используется в случаях, когда нет необходмости в сохранении данных. Например, удаление данных в целях безопасности или когда данные, генерируемые контейнером, нет необходимости хранить, засоряя память. 

